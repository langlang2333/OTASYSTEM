<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title id="title">固件升级</title>
    <base target="_self">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="css/bootstrap-table.min.css">
    <link rel="stylesheet" href="css/bootstrap-editable.css">
    <link rel="stylesheet" href="main1.css">
    <link rel="stylesheet" href="assets/index.css">
    <script src="assets/index.js"></script>
    <script src="js/axios.js"></script>
    <script src="assets/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min1.css">
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="css/style.css"/>

    <link rel="stylesheet" href="css/bootstrap-datetimepicker.css"/>
    <!-- bootstrap-datetimepicker插件CSS-->
    <!--/jquery.文件-->
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script type="text/javascript" src="js/moment.js"></script>
    <!-- 最新的 Bootstrap 核心 Moment文件 -->
    <script type="text/javascript" src="js/bootstrap-datetimepicker.min.js"></script>
    <!-- 最新的 Bootstrap 核心 DateTime文件 -->

    <!-- Latest compiled and minified JavaScript -->
    <script src="js/bootstrap-table.min.js"></script>

    <!-- Latest compiled and minified Locales -->
    <script src="js/bootstrap-table-zh-CN.min.js"></script>


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/json2/20140204/json2.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js "></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <![endif]-->

</head>
<body>
<form id="addForm" action="http://manager.rokyinfo.com:9777/v1/upgrade" method="post" onsubmit="return false" enctype="multipart/form-data">
 <div id="addtask" style="position: fixed; top: 0px; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none;z-index:909;left:0px;">
    <div id="banner" style="width: 850px;height: 50px;background-image: linear-gradient(to bottom,#54b4eb,#2fa4e7);
         background-repeat: repeat-x;border: 1px solid #1990d5;margin: 0 auto;margin-top: 100px;opacity: 1">
        <p style="font-size: 18px; color:#FFF; font-weight:600;line-height: 28px;margin-left: 35px;padding-top: 12px">新增固件升级任务</p>
    </div>
    <div style="width: 850px;height: 560px;background: #FFF;margin: 0 auto;opacity: 1">

            <div><p style="padding-top: 25px;padding-left: 35px; display: inline-block;font-size:15px;font-weight: 600;">筛选策略：</p></div>
            <div style="width: 500px;">

            <p style="padding-top: 25px;padding-left: 35px; display: inline-block">厂商：</p><select  name="firmId" id="s1" class="changshang" style="width: 350px;height: 35px;border-radius: 5px;margin-left: 41px;">

            </select>
            <p style="padding-top: 25px;padding-left: 35px; display: inline-block">DCU型号：</p><select name="dcuHardwareVersion" id="s2" class="xinghao" style="width: 350px;height: 35px;border-radius: 5px;margin-left: 13px;"></select>
            <p style="padding-top: 25px;padding-left: 35px; display: inline-block">DCU版本号：</p><select name="dcuSoftwareVersion" id="s3" class="banben" style="width: 350px;height: 35px;border-radius: 5px;"></select>
            </div>
            <p style="padding-top: 25px;padding-left: 35px; display: inline-block">升级设备列表：</p>
            <input type="file" name="upgradeUEFile" id="file2" class="liebiao" accept=".xls,.xlsx" style="display: inline-block;margin-left: 40px;"/>
            <span style="color: red;padding-left: 30px;">(选择升级设备列表后将只会升级列表中的设备）</span>
            <p style="padding-top: 25px;padding-left: 35px; display: inline-block">待升级版本：</p><select  name="upgradeVersionId" id="s4" class="shengji" style="width: 350px;height: 35px;border-radius: 5px;margin-left: 2px;">

            </select>

            <div><p style="padding-top: 25px;padding-left: 35px; display: inline-block;font-size:15px;font-weight: 600;">执行策略：</p></div>

            <!--<p style="padding-top: 25px;padding-left: 35px; display: inline-block">车辆状态：</p><select name="carStatus" class="zhuangtai" style="width: 350px;height: 35px;border-radius: 5px;margin-left: 14px;">-->
            <!--<option value="" selected = "selected">无</option>-->
            <!--<option value="">设防</option>-->

        <!--</select>-->

        <div style="margin-top: 20px;"><p style="padding-top: 25px;padding-left: 35px; display: inline-block">执行时间：</p>
                <select name="runStrategy" id="s5" class="shijian" style="width: 350px;height: 35px;border-radius: 5px;margin-left: 10px;">
                    <option value="1" selected = "selected">立即执行</option>
                    <option value="0">夜间定时执行</option>
                </select>
            </div>



            <button type="button" class="btn btn-default"  id="close2" style="margin-left: 380px;margin-top: 40px;">取 消</button>
            <!--<input id="insertBtnImportSubmit" class="btn btn-primary" type="submit" style="margin-left: 30px;margin-top: 80px;" value="   提 交   "/>-->
            <button type="button" class="btn btn-default" onclick="upload3()" style="margin-left: 30px;margin-top: 40px;background-image: linear-gradient(to bottom,#46aeea,#2fa4e7);
                            background-repeat: repeat-x;text-shadow: 0 -1px 0 rgba(0,0,0,0.25);background-color: #3daae9;
                            border-color: rgba(0,0,0,0.1) rgba(0,0,0,0.1) rgba(0,0,0,0.25);color: #fff;">确定</button>






    </div>
 </div>
</form>
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" style="background-image: linear-gradient(to bottom,#54b4eb,#2fa4e7);
    background-repeat: repeat-x;
    border: 1px solid #1990d5;">
    <div class="">
        <div class="navbar-header;">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <div class="brand" style="font-size: 26px;color: #fff"><span id="productName">OTA系统</span></div>
            <ul class="nav pull-left" style="padding-top: 5px;">
                <li style="float: left;"> <a  style="font-size:15px;text-decoration : none;color: #fff;    height: 50px;
    margin-top: -5px;padding-top: 15px;" href="list1.html" target="mainFrame" title="">
                    &nbsp;版本列表
                </a></li>
                <li style="float: left;"><a style="font-size:15px;text-decoration : none;color: #fff; height: 50px;
                    margin-top: -5px;padding-top: 15px;" href="list2.html" target="mainFrame" title="">
                    &nbsp;升级任务列表
                </a></li>
            </ul>
            <ul id="signout" class="nav pull-right">

                <li><a href="login.html" title="退出登录" style="color: #fff;font-size: 14px;margin-top: 4px;">退出</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</nav>

<div class="content" style="width: 100%;height:750px;top: 60px;">
    <div class="container" style="width:100%; margin-top:10px;">
        <div class="fixed-table-toolbar">
            <div class="columns columns-right btn-group pull-left">
                <button type="button" class="btn btn-primary" id="upload"
                        style="margin-top: -6px;background-image: linear-gradient(to bottom,#46aeea,#2fa4e7);
                            background-repeat: repeat-x;text-shadow: 0 -1px 0 rgba(0,0,0,0.25);background-color: #3daae9;
                            border-color: rgba(0,0,0,0.1) rgba(0,0,0,0.1) rgba(0,0,0,0.25);">新增固件升级
                </button>
            </div>
        </div>
        <table id="table" class="table table-hover"
               data-search="false"
               data-show-refresh="true"
               data-show-toggle="false"
               data-show-columns="true"
               data-show-export="false"
               data-minimum-count-columns="2"
               data-pagination="true"
               data-id-field="ccuSn"
               data-page-list="[10, 20, 50, 100, ALL]"
               data-show-footer="false"
               data-side-pagination="server"
               data-url="https://manager.rokyinfo.com:9777/v1/upgrade"

               data-response-handler="responseHandler"></table>
    </div>
</div>
</body>
<script>

    var $table = $('#table');
    var  url ="http://manager.rokyinfo.com:9777/v1/upgrade";

    function initTable() {
        $table.bootstrapTable("destroy");
        $table.bootstrapTable({
            height: getHeight(),
            url:url,
            method: 'GET',
            detailView : true,
            dataType: 'json',
            contentType: "application/json; charset=utf-8",
            cache: false,
            striped: false,                              //是否显示行间隔色
            minimumCountColumns: 2,
            queryParams:queryParams,
            uniqueId: "id",
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 20,                       //每页的记录行数（*）
            pageList: [10, 20, 100],        //可供选择的每页的行数（*）
            responseHandler: responseHandler,
            columns: [ {
                field: 'id',
                title: '序号',
                align: 'center',
                valign: 'middle'
            },{
                field: 'upgradeVersionId',
                title: '升级版本',
                align: 'center',
                valign: 'middle'
            }, {
                field: 'runStrategy',
                title: '升级策略',
                align: 'center',
                valign: 'middle',
                formatter:upgradeformatter
            },{
                field: 'successful',
                title: '执行状态（成功设备数/总设备数）',
                align: 'center',
                valign: 'middle',
                formatter:statueformatter
            },{
                field: 'state',
                title: '运行状态',
                align: 'center',
                valign: 'middle',
                formatter:state2formatter

            },{
                field: 'lastRunTime',
                title: '最后运行时间',
                align: 'center',
                valign: 'middle',
                formatter:lastformatter
            },{
                field: 'createTime',
                title: '创建时间',
                align: 'center',
                valign: 'middle',
                formatter:createformatter
            }],
            onExpandRow: function (index, row, $detail) {
                initTable.InitSubTable(index, row, $detail);
            }

        });
        // sometimes footer render error.
    }

    initTable.InitSubTable = function (index, row, $detail) {
        var id2=row.id;
        console.log(id2);

        var url="http://manager.rokyinfo.com:9777/v1/upgradeDetail?upgradeId="+id2;
        var cur_table = $detail.html('<table class="table table-hover"\n' +
            'data-search="false"\n' +
            'data-show-toggle="false"\n' +
            'data-show-export="false"\n' +
            'data-minimum-count-columns="2"\n' +
            'data-pagination="false"\n' +
            'data-id-field="ccuSn"\n' +
            'data-page-list="[10, 20, 50, 100, ALL]"\n' +
            'data-show-footer="false"\n' +
            'data-side-pagination="server"\n' +
            'data-response-handler="responseHandler"></table>').find('table');

        $(cur_table).bootstrapTable({
            url: url,
            method: 'get',
//            queryParams: { strParentID: parentid },
//            ajaxOptions: { strParentID: parentid },
            clickToSelect: true,
            responseHandler: responseHandler,
            queryParams:queryParams,
            pageSize: 10,
            pageList: [10, 20, 50],
            columns: [{
                checkbox: true
            }, {
                field: 'ueSn',
                title: '设备SN号',
                align: 'center',
                valign: 'middle'
            }, {
                field: 'currentVersion',
                title: '当前版本',
                align: 'center',
                valign: 'middle'
            }, {
                field: 'state',
                title: '执行状态',
                align: 'center',
                valign: 'middle',
                formatter:stateformatter
            }, {
                field: 'lastRunTime',
                title: '最后运行时间',
                align: 'center',
                valign: 'middle'
            } ]
            //无线循环取子表，直到子表里面没有记录
//            onExpandRow: function (index, row, $Subdetail) {
//                oInit.InitSubTable(index, row, $Subdetail);
//            }
        });
    };


    function statueformatter(value,row,index) {
        var inner=row.successfulUE+"/"+row.totalUE;
        var color='nowwrp';
        return [
            '<span class='+color+'>'+inner+'</span>'
        ].join('');
    } //执行状态
    function state2formatter(value,row,index) {
        var color='nowwrp';
        if(row.state==0){
            var inner="未运行"
        }
        else if(row.state==1){
            var inner="运行中"
        }
        else if(row.state==2){
            var inner="运行成功"
        }
        return [
            '<span class='+color+'>'+inner+'</span>'
        ].join('');
    }//运行状态父
    function upgradeformatter(value,row,index) {
        if(row.runStrategy==1){
            var inner="立即执行"
        }
        else if(row.runStrategy==0){
            var inner="夜间定时执行"
        }
        var color='nowwrp';
        return [
            '<span class='+color+'>'+inner+'</span>'
        ].join('');
    } //升级策略

    function createformatter(value,row,index) {
        var inner=row.createTime;
        var color='nowwrp';
        return [
            '<span class='+color+'>'+inner+'</span>'
        ].join('');
    } //创建时间

    function lastformatter(value,row,index) {

        if(row.lastRunTime=="null"||row.lastRunTime==null){
            var inner="-"
        }
        else {
            var inner=row.lastRunTime;
        }
        var color='nowwrp';
        return [
            '<span class='+color+'>'+inner+'</span>'
        ].join('');
    } //最后运行时间

    function responseHandler(res) {

        console.log(res.result);

        if (res) {

            return {
                "rows" :res.result,
                "total" : 25
            };
        } else {
            return {
                "rows" : [],
                "total" : 0
            };
        }
    }

    function queryParams(pageReqeust) {

        var temp = {
            offset: this.pageNumber-1,
            limit: this.pageSize
        };

        return temp;
    }


    function stateformatter(value,row,index) {
        var color='nowwrp';
        if(row.state==0){
          var inner="未运行"
        }
        else if(row.state==1){
          var inner="运行中"
        }
        else if(row.state==2){
            var inner="运行成功"
        }
        return [
            '<span class='+color+'>'+inner+'</span>'
        ].join('');
    }//运行状态子


    $("#upload").on("click",function(){

        $.ajax({
            url: "http://manager.rokyinfo.com:9777/v1/firms",
            method: "get",
            contentType: "application/json; charset=utf-8",
            processData:false,
            cache: false,

            success: function (data) {
                console.log(data);
                seDate=data.result;
                console.log(seDate);

                $(".then_remove1").remove();
                var selectID = document.getElementsByClassName("changshang")[0];
                seDate.forEach(function (x,i,f) {
                    var newop = document.createElement("option");

                    newop.innerHTML = x. name;
                    newop.value = x. id;
                    console.log(newop.value);
                    var select = document.getElementById("s1");
                    var value = select.value;
                    console.log(value);
                    newop.className = "then_remove1";
                    selectID.appendChild(newop);
                })

            },
            error: function (err) {
                console.log(err)
            }
        });

        $.ajax({
            url: "http://manager.rokyinfo.com:9777/v1/dcuHardwareVersions",
            method: "get",
            contentType: "application/json; charset=utf-8",
            processData:false,
            cache: false,

            success: function (data) {
                console.log(data);
                seDate2=data.result;
                console.log(seDate2);

                $(".then_remove2").remove();
                var selectID2 = document.getElementsByClassName("xinghao")[0];
                seDate2.forEach(function (x,i,f) {
                    var newop2 = document.createElement("option");

                    newop2.innerHTML = x. dcuHardwareVersion;
                    newop2.className = "then_remove2";
                    selectID2.appendChild(newop2);
                })

            },
            error: function (err) {
                console.log(err)
            }
        });

        $.ajax({
            url: "http://manager.rokyinfo.com:9777/v1/dcuSoftwareVersions",
            method: "get",
            contentType: "application/json; charset=utf-8",
            processData:false,
            cache: false,

            success: function (data) {
                console.log(data);
                seDate3=data.result;
                console.log(seDate3);

                $(".then_remove3").remove();
                var selectID3 = document.getElementsByClassName("banben")[0];
                seDate3.forEach(function (x,i,f) {
                    var newop3 = document.createElement("option");

                    newop3.innerHTML = x. dcuSoftwareVersion;
                    newop3.className = "then_remove3";
                    selectID3.appendChild(newop3);
                })

            },
            error: function (err) {
                console.log(err)
            }
        });

        $.ajax({
            url: "http://manager.rokyinfo.com:9777/v1/firmware",
            method: "get",
            contentType: "application/json; charset=utf-8",
            processData:false,
            cache: false,

            success: function (data) {
                console.log(data);
                seDate4=data.result;
                console.log(seDate4);

                $(".then_remove4").remove();
                var selectID4 = document.getElementsByClassName("shengji")[0];
                seDate4.forEach(function (x,i,f) {
                    var newop4 = document.createElement("option");

                    newop4.innerHTML = x. version;
                    newop4.value = x. id;
                    console.log(newop4.value);
                    var select = document.getElementById("s4");
                    var value = select.value;
                    console.log(value);
                    newop4.className = "then_remove4";
                    selectID4.appendChild(newop4);
                })

            },
            error: function (err) {
                console.log(err)
            }
        });


        $("#addtask").css("display","block");
        $("#close2").on("click",function () {

            $("#addtask").hide()
        })
    });

    function upload3() {
        var fileVal2 = document.getElementById("file2").value;
        if(!fileVal2){
            alert("请选择升级设备列表！");
            return false;
        }
        var formData = new FormData($("#addForm")[0]);
        console.log(formData);
        $.ajax({
            url: 'http://manager.rokyinfo.com:9777/v1/upgrade',
            type: 'POST',
            data: formData,

            async: false,
            cache: false,
            contentType: false,
            processData: false,
            success: function(res) {
                console.log("成功");
                alert("新增任务成功");
                $table.bootstrapTable("refresh",{silent: true});
                $("#addtask").hide()
            },
            error: function(res) {
                alert("新增失败")
            }
        });
    }


</script>
<script type="text/javascript">
    function getHeight() {
        return $(window).height() - $('h1').outerHeight(true) - $('nav').outerHeight(true) ;
    }
    initTable();
//    timer=setInterval(function () {
//         $table.bootstrapTable("refresh",{silent: true})
//        },5000);
    $(window).resize(function () {
        $table.bootstrapTable('resetView', {
            height:$(window).height() - 70
        });
    });

</script>
</html>